<%- include('partials/header') %>
<%- include('partials/sidebar', { page: 'envio', user }) %>

<style>
  .section-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 8px;
  }

  .area-flex {
    display: flex;
    gap: 20px;
    width: 100%;
    align-items: stretch;
  }

  .box {
    background: #fff;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    min-width: 0;
  }

  .lista-maquinas {
    height: 350px;
    overflow-y: auto;
  }

  .item-maq {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    background: #f8f8f8;
  }

  .item-maq.selecionada {
    background: #dce9ff;
    border-color: #7bb3ff;
  }

  .selecionadas-box {
    height: 350px;
    border: 1px dashed #bfbfbf;
    background: #f7faff;
    padding: 10px;
    overflow-y: auto;
  }

  /* lista selecionadas: bot√£o nunca some */
  #listaSelecionadas {
    margin: 0;
    padding: 0;
  }
  #listaSelecionadas li{
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 10px;
    margin-bottom: 8px;
    background: #fff;
    border: 1px solid #d7d7d7;
    border-radius: 8px;
    min-width: 0;
  }
  #listaSelecionadas li .serial-text{
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 600;
    color: #333;
  }

  .campo {
    margin-bottom: 12px;
  }

  .campo label {
    font-weight: bold;
    display: block;
    margin-bottom: 4px;
  }

  .btn-registrar {
    display: block;
    width: 100%;
    max-width: 600px;
    margin: 30px auto 40px;
    background: #0066ff;
    border: none;
    padding: 16px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: 0.2s ease;
    text-align: center;
  }

  .btn-registrar:hover {
    background: #0053d6;
    transform: translateY(-2px);
  }

  .btn-registrar:disabled {
    opacity: 0.7;
    cursor: not-allowed !important;
  }

  .btn-remove {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 2px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    flex: 0 0 auto;
  }

  .btn-remove:hover {
    background: #cc0000;
  }

  #buscaSerial {
    width: 100% !important;
    max-width: 100% !important;
    margin-bottom: 10px;
    font-size: 15px;
    height: 38px;
  }

  /* ‚úÖ MOBILE */
  @media (max-width: 900px){
    .area-flex{
      flex-direction: column;
    }
    .lista-maquinas,
    .selecionadas-box{
      height: 280px;
    }
    .btn-registrar{
      max-width: 100%;
    }
  }
</style>

<div class="main-content">

  <h1>Controle de Envio / Retorno</h1>

  <div class="area-flex">

    <!-- LISTA -->
    <div class="box">
      <div class="section-title">M√°quinas (Serial + Status)</div>

      <input id="buscaSerial" type="text" class="form-control" placeholder="Pesquisar serial...">
      <div class="lista-maquinas" id="listaMaquinas"></div>
    </div>

    <!-- SELECIONADAS -->
    <div class="box">
      <div class="section-title">Selecionadas</div>
      <div class="selecionadas-box">
        <ul id="listaSelecionadas"></ul>
      </div>
    </div>

  </div>

  <!-- FORMUL√ÅRIO -->
  <form id="formEnvio" style="margin-top: 25px;">

    <div class="box">

      <div class="campo">
        <label>A√ß√£o</label>
        <select name="acao" id="acaoSelect" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="Envio SP">Envio SP</option>
          <option value="Envio RJ">Envio RJ</option>
          <option value="Envio URA">Envio URA</option>
          <option value="Envio Fixo">Envio Fixo</option>
          <option value="Retorno SP">Retorno SP</option>
          <option value="Retorno RJ">Retorno RJ</option>
          <option value="Retorno URA">Retorno URA</option>
        </select>
      </div>

      <!-- ‚úÖ ID EVENTO (s√≥ envio) -->
      <div class="campo" id="grpIdEvento">
        <label>ID Evento</label>
        <!-- sem setinhas -->
        <input
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          name="id_evento"
          id="idEvento"
          class="form-control"
          placeholder="Ex: 66689"
        >
      </div>

      <!-- ‚úÖ DATA ENVIO / SA√çDA (s√≥ envio, inclusive fixo) -->
      <div class="campo" id="grpDataSaida">
        <label>Data de Envio</label>
        <input type="date" name="dt_saida" id="dtSaida" class="form-control">
      </div>

      <!-- ‚úÖ DATA RETORNO (s√≥ envio normal, n√£o fixo) -->
      <div class="campo" id="grpDataRetorno">
        <label>Data de Retorno</label>
        <input type="date" name="dt_retorno" id="dtRetorno" class="form-control">
      </div>

      <div class="campo">
        <label>Observa√ß√µes</label>
        <textarea name="obs" id="obs" class="form-control" rows="3" placeholder="Opcional..."></textarea>
      </div>

    </div>

    <button type="submit" class="btn-registrar" id="btnRegistrar">
      Registrar movimenta√ß√£o
    </button>

  </form>

</div>

<script>
/* ===============================
   DADOS DO SERVIDOR
=============================== */
const maquinas = <%- JSON.stringify(maquinas || []) %>;

/* ===============================
   ESTADO
=============================== */
let selecionadas = [];
let maquinasPorSerial = {};

/* ===============================
   ELEMENTOS
=============================== */
const lista = document.getElementById("listaMaquinas");
const listaSel = document.getElementById("listaSelecionadas");
const busca = document.getElementById("buscaSerial");
const acaoSelect = document.getElementById("acaoSelect");

const grpIdEvento = document.getElementById("grpIdEvento");
const grpDataSaida = document.getElementById("grpDataSaida");
const grpDataRetorno = document.getElementById("grpDataRetorno");

const form = document.getElementById("formEnvio");
const btnRegistrar = document.getElementById("btnRegistrar");

/* ===============================
   INDEXAR STATUS POR SERIAL
=============================== */
maquinas.forEach(m => {
  const serial = String(m.serial || "").trim();
  maquinasPorSerial[serial] = String(m.status || "").trim();
});

/* ===============================
   RENDER LISTA
=============================== */
function renderLista(filtro = "") {
  lista.innerHTML = "";

  // üî• quebra por v√≠rgula e limpa espa√ßos
  const termos = filtro
    .toLowerCase()
    .split(",")
    .map(t => t.trim())
    .filter(t => t !== "");

  const filtradas = maquinas.filter(m => {
    const serial = String(m.serial || "").toLowerCase();

    // se n√£o digitou nada, mostra tudo
    if (termos.length === 0) return true;

    // mostra se bater com QUALQUER serial digitado
    return termos.some(t => serial.includes(t));
  });


  filtradas.forEach(m => {
    const serial = String(m.serial || "").trim();
    const status = String(m.status || "").trim();

    const div = document.createElement("div");
    div.className = "item-maq";
    div.textContent = `${serial} - ${status}`;

    if (selecionadas.includes(serial)) div.classList.add("selecionada");

    div.onclick = () => {
      if (selecionadas.includes(serial)) {
        selecionadas = selecionadas.filter(x => x !== serial);
      } else {
        selecionadas.push(serial);
      }
      renderLista(busca.value);
      renderSel();
    };

    lista.appendChild(div);
  });
}

/* ===============================
   RENDER SELECIONADAS
=============================== */
function renderSel() {
  listaSel.innerHTML = "";

  if (selecionadas.length === 0) {
    listaSel.innerHTML =
      "<li style='color:#777;text-align:center;justify-content:center;'>Nenhuma m√°quina selecionada</li>";
    return;
  }

  selecionadas.forEach(s => {
    const li = document.createElement("li");

    li.innerHTML = `
      <span class="serial-text">${s}</span>
      <button type="button" class="btn-remove" onclick="removerSel('${s.replace(/'/g, "\\'")}')">√ó</button>
    `;

    listaSel.appendChild(li);
  });
}

function removerSel(s) {
  selecionadas = selecionadas.filter(x => x !== s);
  renderLista(busca.value);
  renderSel();
}

/* ===============================
   REGRAS DE CAMPOS (ENVIO/RETORNO)
=============================== */
function atualizarCamposPorAcao() {
  const acao = acaoSelect.value || "";

  const isEnvio = acao.includes("Envio");
  const isRetorno = acao.includes("Retorno");
  const isEnvioFixo = acao === "Envio Fixo";

  // Envio: mostra ID + data envio
  grpIdEvento.style.display = isEnvio ? "block" : "none";
  grpDataSaida.style.display = isEnvio ? "block" : "none";

  // Retorno: n√£o usa essas datas no backend
  if (isRetorno) {
    grpDataRetorno.style.display = "none";
  } else {
    // Envio normal: precisa retorno; Envio Fixo: n√£o
    grpDataRetorno.style.display = (isEnvio && !isEnvioFixo) ? "block" : "none";
  }
}
acaoSelect.addEventListener("change", atualizarCamposPorAcao);
atualizarCamposPorAcao();

/* ===============================
   VALIDAR STATUS (front)
=============================== */
function validarStatus(acao, seriais) {
  const erros = [];

  seriais.forEach(serial => {
    const status = String(maquinasPorSerial[serial] || "").toLowerCase();

    if (acao.includes("Envio")) {
      if (status.includes("em uso") || status.includes("fixo")) {
        erros.push(`${serial} j√° est√° em uso/fixo (${maquinasPorSerial[serial]})`);
      }
    }

    if (acao.includes("Retorno")) {
      // ‚úÖ permite retorno de "Em Uso" e de "Fixo"
      if (!(status.includes("em uso") || status.includes("fixo"))) {
        erros.push(`${serial} n√£o est√° em uso/fixo (status atual: ${maquinasPorSerial[serial] || "-"})`);
      }
    }
  });

  return erros;
}

/* ===============================
   SUBMIT
=============================== */
async function enviarPayload(payload) {
  const resp = await fetch("/api/registrar-envio", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  // se backend devolver html por algum motivo, isso pode quebrar
  const contentType = resp.headers.get("content-type") || "";
  if (!contentType.includes("application/json")) {
    const txt = await resp.text();
    return { ok: false, msg: "Resposta inv√°lida do servidor.", raw: txt };
  }

  return await resp.json();
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const acao = acaoSelect.value;

  const id_evento = (document.getElementById("idEvento").value || "").trim();
  const dt_saida = document.getElementById("dtSaida").value || "";
  const dt_retorno = document.getElementById("dtRetorno").value || "";
  const obs = document.getElementById("obs").value || "";

  if (!acao) return alert("Selecione uma a√ß√£o.");
  if (selecionadas.length === 0) return alert("Selecione ao menos 1 m√°quina.");

  const isEnvio = acao.includes("Envio");
  const isRetorno = acao.includes("Retorno");
  const isEnvioFixo = acao === "Envio Fixo";

  // valida√ß√µes do fluxo (igual backend)
  if (isEnvio) {
    if (!id_evento) return alert("Informe o ID do Evento.");
    if (!dt_saida) return alert("Informe a Data de Envio.");
    if (!isEnvioFixo && !dt_retorno) return alert("Informe a Data de Retorno.");
  }

  // valida status
  const erros = validarStatus(acao, selecionadas);
  if (erros.length) return alert("Ajuste antes de prosseguir:\n\n" + erros.join("\n"));

  btnRegistrar.disabled = true;
  const txtOriginal = btnRegistrar.textContent;
  btnRegistrar.textContent = "Registrando...";

  try {
    // payload alinhado ao backend
    const payload = {
      acao,
      seriais: selecionadas,
      id_evento: isEnvio ? id_evento : "",
      dt_saida: isEnvio ? dt_saida : "",
      dt_retorno: (isEnvio && !isEnvioFixo) ? dt_retorno : "",
      obs
    };

    let data = await enviarPayload(payload);

    // se retorno precisar origem manual (popup)
    if (data && data.needsPopup) {
      const origem = prompt(
        "Alguns seriais n√£o possuem hist√≥rico/origem.\n\n" +
        "Digite uma observa√ß√£o de origem (ex: 'Retorno sem hist√≥rico - veio do estoque X'):"
      );

      if (!origem) {
        alert("Opera√ß√£o cancelada. Sem origem n√£o √© poss√≠vel registrar esses retornos.");
        return;
      }

      // reenviar com obs_origem (backend j√° espera isso)
      data = await enviarPayload({ ...payload, obs_origem: origem });
    }

    if (data && data.ok) {
      alert("Movimenta√ß√£o registrada!");
      location.reload();
    } else {
      alert((data && data.msg) ? data.msg : "Erro ao registrar.");
    }
  } catch (err) {
    alert("Erro de rede.");
  } finally {
    btnRegistrar.disabled = false;
    btnRegistrar.textContent = txtOriginal;
  }
});

/* INIT */
busca.addEventListener("input", () => renderLista(busca.value));
renderLista("");
renderSel();
</script>

<%- include('partials/footer') %>
