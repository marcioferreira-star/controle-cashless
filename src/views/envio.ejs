<%- include('partials/header') %>
<%- include('partials/sidebar', { page: 'envio', user }) %>

<style>
  .section-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; }
  .area-flex { display: flex; gap: 20px; width: 100%; align-items: stretch; }
  .box { background: #fff; border: 1px solid #dcdcdc; border-radius: 8px; padding: 15px; width: 100%; min-width: 0; }
  .lista-maquinas { height: 350px; overflow-y: auto; }

  .item-maq {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    background: #f8f8f8;
  }
  .item-maq.selecionada { background: #dce9ff; border-color: #7bb3ff; }

  .selecionadas-box {
    height: 350px;
    border: 1px dashed #bfbfbf;
    background: #f7faff;
    padding: 10px;
    overflow-y: auto;
  }

  #listaSelecionadas { margin: 0; padding: 0; }
  #listaSelecionadas li{
    list-style: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 10px;
    margin-bottom: 8px;
    background: #fff;
    border: 1px solid #d7d7d7;
    border-radius: 8px;
    min-width: 0;
  }
  #listaSelecionadas li .serial-text{
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 600;
    color: #333;
  }

  .campo { margin-bottom: 12px; }
  .campo label { font-weight: bold; display: block; margin-bottom: 4px; }

  .btn-registrar {
    display: block;
    width: 100%;
    max-width: 600px;
    margin: 30px auto 40px;
    background: #0066ff;
    border: none;
    padding: 16px;
    font-size: 18px;
    font-weight: 600;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: 0.2s ease;
    text-align: center;
  }
  .btn-registrar:hover { background: #0053d6; transform: translateY(-2px); }
  .btn-registrar:disabled { opacity: 0.7; cursor: not-allowed !important; }

  .btn-remove {
    background: #ff4d4d;
    color: white;
    border: none;
    padding: 2px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    flex: 0 0 auto;
  }
  .btn-remove:hover { background: #cc0000; }

  #buscaSerial {
    width: 100% !important;
    max-width: 100% !important;
    margin-bottom: 10px;
    font-size: 15px;
    height: 38px;
  }

  @media (max-width: 900px){
    .area-flex{ flex-direction: column; }
    .lista-maquinas, .selecionadas-box{ height: 280px; }
    .btn-registrar{ max-width: 100%; }
  }
</style>

<div class="main-content">
  <h1>Controle de Movimentação</h1>

  <div class="area-flex">
    <!-- LISTA -->
    <div class="box">
      <div class="section-title">Máquinas (Serial + Status)</div>
      <input id="buscaSerial" type="text" class="form-control" placeholder="Pesquisar serial... (aceita vírgula: 123, 456)">
      <div class="lista-maquinas" id="listaMaquinas"></div>
    </div>

    <!-- SELECIONADAS -->
    <div class="box">
      <div class="section-title">Selecionadas</div>
      <div class="selecionadas-box">
        <ul id="listaSelecionadas"></ul>
      </div>
    </div>
  </div>

  <!-- FORMULÁRIO -->
  <form id="formEnvio" style="margin-top: 25px;">
    <div class="box">
      <div class="campo">
        <label>Ação</label>
        <select name="acao_ui" id="acaoSelect" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="ENVIO">Envio</option>
          <option value="ENVIO_FIXO">Envio Fixo</option>
          <option value="RETORNO">Retorno</option>
          <option value="MANUTENCAO">Manutenção</option>
        </select>
      </div>

      <div class="campo" id="grpLocal">
        <label>Local</label>
        <select name="local" id="localSelect" class="form-control" required>
          <option value="">Selecione...</option>
          <option value="SP">SP</option>
          <option value="RJ">RJ</option>
          <option value="URA">URA</option>
        </select>
      </div>

      <!-- Evento: só faz sentido para ENVIO / ENVIO_FIXO -->
      <div class="campo" id="grpEvento">
        <label>Evento</label>
        <input
          type="text"
          name="evento"
          id="evento"
          class="form-control"
          placeholder="Ex: Carnaval RJ 2026 (ou ID interno se você preferir)"
        >
      </div>

      <div class="campo">
        <label>Observações</label>
        <textarea name="observacoes" id="observacoes" class="form-control" rows="3" placeholder="Opcional..."></textarea>
      </div>
    </div>

    <button type="submit" class="btn-registrar" id="btnRegistrar">
      Registrar movimentação
    </button>
  </form>
</div>

<script>
/* ===============================
   DADOS DO SERVIDOR
=============================== */
const maquinas = <%- JSON.stringify(maquinas || []) %>;

/* ===============================
   ESTADO
=============================== */
let selecionadas = [];
let maquinasPorSerial = {};

/* ===============================
   ELEMENTOS
=============================== */
const lista = document.getElementById("listaMaquinas");
const listaSel = document.getElementById("listaSelecionadas");
const busca = document.getElementById("buscaSerial");
const acaoSelect = document.getElementById("acaoSelect");
const localSelect = document.getElementById("localSelect");

const grpEvento = document.getElementById("grpEvento");
const grpLocal = document.getElementById("grpLocal");

const form = document.getElementById("formEnvio");
const btnRegistrar = document.getElementById("btnRegistrar");

/* ===============================
   INDEXAR STATUS POR SERIAL
=============================== */
maquinas.forEach(m => {
  const serial = String(m.serial || "").trim();
  maquinasPorSerial[serial] = String(m.status || "").trim();
});

/* ===============================
   RENDER LISTA
=============================== */
function renderLista(filtro = "") {
  lista.innerHTML = "";

  const termos = filtro
    .toLowerCase()
    .split(",")
    .map(t => t.trim())
    .filter(t => t !== "");

  const filtradas = maquinas.filter(m => {
    const serial = String(m.serial || "").toLowerCase();
    if (termos.length === 0) return true;
    return termos.some(t => serial.includes(t));
  });

  filtradas.forEach(m => {
    const serial = String(m.serial || "").trim();
    const status = String(m.status || "").trim();

    const div = document.createElement("div");
    div.className = "item-maq";
    div.textContent = `${serial} - ${status}`;

    if (selecionadas.includes(serial)) div.classList.add("selecionada");

    div.onclick = () => {
      if (selecionadas.includes(serial)) {
        selecionadas = selecionadas.filter(x => x !== serial);
      } else {
        selecionadas.push(serial);
      }
      renderLista(busca.value);
      renderSel();
    };

    lista.appendChild(div);
  });
}

/* ===============================
   RENDER SELECIONADAS
=============================== */
function renderSel() {
  listaSel.innerHTML = "";

  if (selecionadas.length === 0) {
    listaSel.innerHTML =
      "<li style='color:#777;text-align:center;justify-content:center;'>Nenhuma máquina selecionada</li>";
    return;
  }

  selecionadas.forEach(s => {
    const li = document.createElement("li");
    li.innerHTML = `
      <span class="serial-text">${s}</span>
      <button type="button" class="btn-remove" onclick="removerSel('${s.replace(/'/g, "\\'")}')">×</button>
    `;
    listaSel.appendChild(li);
  });
}

function removerSel(s) {
  selecionadas = selecionadas.filter(x => x !== s);
  renderLista(busca.value);
  renderSel();
}

/* ===============================
   REGRAS POR AÇÃO
   - Evento só aparece no envio/envio fixo
   - Local sempre obrigatório (você pode mudar depois)
=============================== */
function atualizarCamposPorAcao() {
  const acao = acaoSelect.value || "";
  const isEnvio = (acao === "ENVIO" || acao === "ENVIO_FIXO");

  grpEvento.style.display = isEnvio ? "block" : "none";

  // se não for envio, limpa evento para não mandar lixo
  if (!isEnvio) document.getElementById("evento").value = "";
}

acaoSelect.addEventListener("change", atualizarCamposPorAcao);
atualizarCamposPorAcao();

/* ===============================
   VALIDAR STATUS (front)
=============================== */
function validarStatus(acao, seriais) {
  const erros = [];

  seriais.forEach(serial => {
    const status = String(maquinasPorSerial[serial] || "").toLowerCase();

    if (acao === "ENVIO" || acao === "ENVIO_FIXO") {
      // para envio, exige estoque
      if (!status.includes("estoque")) {
        erros.push(`${serial} não está em estoque (status atual: ${maquinasPorSerial[serial] || "-"})`);
      }
    }

    if (acao === "RETORNO") {
      // retorno permite em uso / fixo / manutenção
      const ok = status.includes("em uso") || status.includes("fixo") || status.includes("manuten");
      if (!ok) {
        erros.push(`${serial} não está em uso/fixo/manutenção (status atual: ${maquinasPorSerial[serial] || "-"})`);
      }
    }
  });

  return erros;
}

/* ===============================
   SUBMIT
=============================== */
async function enviarPayload(payload) {
  const resp = await fetch("/api/registrar-envio", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const contentType = resp.headers.get("content-type") || "";
  if (!contentType.includes("application/json")) {
    const txt = await resp.text();
    return { ok: false, msg: "Resposta inválida do servidor.", raw: txt };
  }

  return await resp.json();
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const acao = acaoSelect.value;
  const local = (localSelect.value || "").trim();
  const evento = (document.getElementById("evento").value || "").trim();
  const observacoes = (document.getElementById("observacoes").value || "").trim();

  if (!acao) return alert("Selecione uma ação.");
  if (!local) return alert("Selecione o local.");
  if (selecionadas.length === 0) return alert("Selecione ao menos 1 máquina.");

  const isEnvio = (acao === "ENVIO" || acao === "ENVIO_FIXO");
  if (isEnvio && !evento) {
    return alert("Informe o evento (pode ser nome ou ID).");
  }

  // valida status
  const erros = validarStatus(acao, selecionadas);
  if (erros.length) return alert("Ajuste antes de prosseguir:\n\n" + erros.join("\n"));

  btnRegistrar.disabled = true;
  const txtOriginal = btnRegistrar.textContent;
  btnRegistrar.textContent = "Registrando...";

  try {
    const payload = {
      acao,
      seriais: selecionadas,
      local,
      // no retorno/manutenção, evento pode ser vazio
      evento: isEnvio ? evento : (evento || "-"),
      observacoes: observacoes || "-"
    };

    const data = await enviarPayload(payload);

    if (data && data.ok) {
      alert("Movimentação registrada!");
      location.reload();
    } else {
      alert((data && data.msg) ? data.msg : "Erro ao registrar.");
    }
  } catch (err) {
    alert("Erro de rede.");
  } finally {
    btnRegistrar.disabled = false;
    btnRegistrar.textContent = txtOriginal;
  }
});

/* INIT */
busca.addEventListener("input", () => renderLista(busca.value));
renderLista("");
renderSel();
</script>

<%- include('partials/footer') %>
