<%- include('partials/header') %>
<%- include('partials/sidebar', { page, user }) %>

<style>
  .filters-box {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  .filters-box input,
  .filters-box select {
    height: 38px;
    padding-left: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    flex: 1;
  }

  .btn-limpar, .btn-exportar {
    height: 38px;
    padding: 0 18px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    color: #fff;
    white-space: nowrap;
  }

  .btn-limpar { background: #555; }
  .btn-exportar { background: #0a7cff; }

  #contador {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #333;
  }

  .table-wrapper {
    max-height: 68vh;
    overflow-y: auto;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 8px;
    border: 1px solid #c9c9c9;
  }

  table {
    width: 100%;
    min-width: 1200px;
    border-collapse: collapse;
  }

  thead th {
    position: sticky;
    top: 0;
    background: #0057d8;
    color: white;
    padding: 10px;
    font-size: 14px;
    z-index: 5;
    white-space: nowrap;
  }

  tbody td {
    padding: 10px;
    background: #fff;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
  }

  .btn-salvar {
    background: #0066ff;
    border: none;
    padding: 6px 14px;
    color: white;
    border-radius: 6px;
    cursor: pointer;
  }

  .mini-input {
    height: 34px;
    border-radius: 6px;
    border: 1px solid #d0d0d0;
    padding: 0 8px;
    width: 100%;
  }

  .muted {
    color: #666;
    font-size: 12px;
  }

  @media (max-width: 900px){
    .filters-box{ flex-wrap: wrap; }
    .filters-box input,
    .filters-box select{
      flex: 1 1 48%;
      min-width: 160px;
    }
    .btn-limpar, .btn-exportar{
      flex: 1 1 48%;
    }
  }
</style>

<div class="main-content">
  <h1>Máquinas</h1>

  <div id="contador">Exibindo 0 máquinas</div>

  <!-- ===================== FILTROS ===================== -->
  <div class="filters-box">
    <input type="text" id="filtroSerial" placeholder="Serials (ex: PBA123,11703)">
    <input type="text" id="filtroPatrimonio" placeholder="Patrimônio (ex: PAT-00123)">

    <select id="filtroStatus" data-label="Status">
      <option value="">Status</option>
    </select>

    <select id="filtroLocal" data-label="Local">
      <option value="">Local</option>
    </select>

    <select id="filtroEvento" data-label="Evento">
      <option value="">Evento</option>
    </select>

    <button class="btn-limpar" id="btnLimpar">Limpar</button>
    <button class="btn-exportar" id="btnExportar">Exportar Excel</button>
  </div>

  <!-- ===================== TABELA ===================== -->
  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Modelo</th>
          <th>Serial</th>
          <th>Código ID</th>
          <th>Patrimonio</th>
          <th>Status</th>
          <th>Local</th>
          <th>Evento</th>
          <th>Tipo</th>
          <th>Observações</th>
          <th>Atualizado em</th>
          <th>Ação</th>
        </tr>
      </thead>

      <tbody id="listaMaquinas">
        <% maquinas.forEach((m, i) => { %>
          <tr
            class="linha"
            data-serial="<%= (m.serial || '').toLowerCase() %>"
            data-codigoid="<%= (m.codigoId || '').toLowerCase() %>"
            data-patrimonio="<%= (m.patrimonio || '').toLowerCase() %>"
            data-status="<%= (m.status || '-').trim() %>"
            data-local="<%= (m.local || '-').trim() %>"
            data-evento="<%= (m.evento || '-').trim() %>"
          >
            <td><%= i + 1 %></td>
            <td><%= m.modelo || '-' %></td>
            <td><%= m.serial || '-' %></td>
            <td><%= m.codigoId || '-' %></td>
            <td><%= m.patrimonio || '-' %></td>

            <td>
              <select class="select-status" id="status_<%= m.linha %>">
                <% const sts = ["Estoque","Em Uso","Fixo","Manutenção"]; %>
                <% sts.forEach(s => { %>
                  <option value="<%= s %>" <%= (String(m.status).trim() === s ? "selected" : "") %>><%= s %></option>
                <% }) %>
              </select>
            </td>

            <td>
              <select class="select-local" id="local_<%= m.linha %>">
                <% const locs = ["-","SP","RJ","URA"]; %>
                <% locs.forEach(l => { %>
                  <option value="<%= l %>" <%= (String(m.local || '-').trim() === l ? "selected" : "") %>><%= l %></option>
                <% }) %>
              </select>
            </td>

            <td>
              <input
                class="mini-input"
                id="evento_<%= m.linha %>"
                value="<%= (m.evento || '-') %>"
                placeholder="Evento"
              />
            </td>

            <td>
              <input
                class="mini-input"
                id="tipo_<%= m.linha %>"
                value="<%= (m.tipo || '-') %>"
                placeholder="Tipo"
              />
            </td>

            <td>
              <input
                class="mini-input"
                id="obs_<%= m.linha %>"
                value="<%= (m.observacoes || '-') %>"
                placeholder="Observações"
              />
            </td>

            <td><%= m.atualizadoEm || '-' %></td>

            <td>
              <button
                class="btn-salvar"
                data-serial="<%= m.serial %>"
                data-linha="<%= m.linha %>"
              >
                Salvar
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* ============================================================
   VARIÁVEIS
============================================================ */
const linhas = [...document.querySelectorAll(".linha")];
const filtroSerial  = document.getElementById("filtroSerial");
const filtroPatrimonio = document.getElementById("filtroPatrimonio");
const filtroStatus  = document.getElementById("filtroStatus");
const filtroLocal   = document.getElementById("filtroLocal");
const filtroEvento  = document.getElementById("filtroEvento");
const btnLimpar     = document.getElementById("btnLimpar");
const btnExportar   = document.getElementById("btnExportar");
const contador      = document.getElementById("contador");

/* ============================================================
   CONTADOR
============================================================ */
function atualizarContador() {
  const vis = linhas.filter(l => l.style.display !== "none").length;
  contador.innerHTML = `Exibindo <b>${vis}</b> de <b>${linhas.length}</b> máquinas`;
}

/* ============================================================
   FILTROS
============================================================ */
function aplicarFiltros() {
  const txtSerial = (filtroSerial.value || "").toLowerCase();
  const txtPat    = (filtroPatrimonio.value || "").toLowerCase();
  const st  = filtroStatus.value;
  const loc = filtroLocal.value;
  const ev  = filtroEvento.value;

  linhas.forEach(row => {
    let mostrar = true;

    const serial = row.dataset.serial || "";
    const patrimonio = row.dataset.patrimonio || "";
    const status = row.dataset.status || "";
    const local  = row.dataset.local || "";
    const evento = row.dataset.evento || "";

    // multi-serial por vírgula
    if (txtSerial) {
      const termos = txtSerial.split(",").map(t => t.trim()).filter(t => t);
      if (!termos.some(t => serial.includes(t))) mostrar = false;
    }

    // multi-patrimonio por vírgula
    if (txtPat) {
      const termos = txtPat.split(",").map(t => t.trim()).filter(t => t);
      if (!termos.some(t => patrimonio.includes(t))) mostrar = false;
    }

    if (st && status !== st) mostrar = false;
    if (loc && local !== loc) mostrar = false;
    if (ev && evento !== ev) mostrar = false;

    row.style.display = mostrar ? "" : "none";
  });

  atualizarFiltrosInteligentes();
  atualizarContador();
}

/* ============================================================
   FILTROS INTELIGENTES
============================================================ */
function atualizarFiltro(select, values) {
  const label = select.dataset.label;
  const atual = select.value;

  select.innerHTML = `<option value="">${label}</option>`;
  values.forEach(v => {
    const op = document.createElement("option");
    op.value = v;
    op.textContent = v;
    select.appendChild(op);
  });

  if (values.includes(atual)) select.value = atual;
}

function atualizarFiltrosInteligentes() {
  const vis = linhas.filter(l => l.style.display !== "none");

  atualizarFiltro(filtroStatus, [...new Set(vis.map(l => l.dataset.status))].filter(Boolean));
  atualizarFiltro(filtroLocal,  [...new Set(vis.map(l => l.dataset.local))].filter(Boolean));
  atualizarFiltro(
    filtroEvento,
    [...new Set(vis.map(l => l.dataset.evento))].filter(x => x && x !== "-")
  );
}

/* ============================================================
   EVENTOS DE FILTRO
============================================================ */
[filtroSerial, filtroPatrimonio, filtroStatus, filtroLocal, filtroEvento]
  .forEach(f => {
    f.addEventListener("input", aplicarFiltros);
    f.addEventListener("change", aplicarFiltros);
  });

btnLimpar.addEventListener("click", () => {
  filtroSerial.value = "";
  filtroPatrimonio.value = "";
  filtroStatus.value = "";
  filtroLocal.value = "";
  filtroEvento.value = "";
  aplicarFiltros();
});

/* ============================================================
   EXPORTAR EXCEL
============================================================ */
btnExportar.addEventListener("click", () => {
  const vis = linhas.filter(l => l.style.display !== "none");
  if (vis.length === 0) return alert("Nenhuma máquina filtrada.");

  const dados = vis.map(row => {
    const tds = row.children;
    return {
      Modelo: tds[1].innerText.trim(),
      Serial: tds[2].innerText.trim(),
      CodigoID: tds[3].innerText.trim(),
      Patrimonio: tds[4].innerText.trim(),
      Status: row.querySelector(".select-status").value,
      Local: row.querySelector(".select-local").value,
      Evento: row.querySelector("input[id^='evento_']").value.trim(),
      Tipo: row.querySelector("input[id^='tipo_']").value.trim(),
      Observacoes: row.querySelector("input[id^='obs_']").value.trim(),
      AtualizadoEm: tds[10].innerText.trim()
    };
  });

  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Maquinas");
  XLSX.writeFile(wb, "maquinas_filtradas.xlsx");
});


/* ============================================================
   SALVAR
   - usa /api/atualizar-status
   - registra histórico automaticamente
============================================================ */
/*
document.querySelectorAll(".btn-salvar").forEach(btn => {
  btn.addEventListener("click", async () => {
    const serial = btn.dataset.serial;
    const linha = btn.dataset.linha;

    const status = document.getElementById(`status_${linha}`).value;
    const local = document.getElementById(`local_${linha}`).value;
    const evento = (document.getElementById(`evento_${linha}`).value || "-").trim();
    const observacoes = (document.getElementById(`obs_${linha}`).value || "-").trim();

    btn.disabled = true;
    const oldTxt = btn.textContent;
    btn.textContent = "Salvando...";

    try {
      const resp = await fetch("/api/atualizar-status", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ serial, status, local, evento, observacoes })
      });

      const data = await resp.json();

      if (data.ok) {
        alert("Atualizado!");
        location.reload();
      } else {
        alert(data.msg || "Erro ao atualizar.");
      }
    } catch (e) {
      alert("Erro de rede.");
    } finally {
      btn.disabled = false;
      btn.textContent = oldTxt;
    }
  });
});
*/

/* INIT */
atualizarFiltrosInteligentes();
atualizarContador();
</script>

<%- include('partials/footer') %>
